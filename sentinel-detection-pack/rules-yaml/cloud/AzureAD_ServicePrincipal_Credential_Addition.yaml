id: 4d4e41cd-a8b8-49f1-828e-fddbb8d74d12
name: Service Principal Creation with Credential Addition
description: |
  Detects service principal creation followed quickly by credential addition.
  Data sources: AuditLogs (Microsoft Entra ID).
  Tuning: adjust CorrelationWindow and allowlist known onboarding automation.
  Recommended actions: verify app ownership, rotate credentials, and review consent grants.
severity: High
status: Production
requiredDataConnectors:
  - connectorId: AzureActiveDirectory
    dataTypes:
      - AuditLogs
queryFrequency: PT5M
queryPeriod: PT1D
triggerOperator: GreaterThan
triggerThreshold: 0
tactics:
  - Persistence
  - PrivilegeEscalation
techniques:
  - T1136.003
query: |
  let QueryPeriod = 1d;
  let CorrelationWindow = 1h;
  // Identify service principal creation events.
  let CreationEvents = AuditLogs
  | where TimeGenerated >= ago(QueryPeriod)
  | where OperationName in ("Add service principal", "Add service principal (preview)")
  | extend TargetResources = todynamic(TargetResources)
  | extend ServicePrincipalId = tostring(TargetResources[0].id)
  | extend ServicePrincipalName = tostring(TargetResources[0].displayName)
  | extend Creator = coalesce(tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName), "Unknown")
  | where isnotempty(ServicePrincipalId)
  | project CreationTime=TimeGenerated, ServicePrincipalId, ServicePrincipalName, Creator;
  // Identify credential additions for service principals.
  let CredentialEvents = AuditLogs
  | where TimeGenerated >= ago(QueryPeriod)
  | where OperationName has_any ("Add service principal credentials", "Add key credentials", "Add password credentials")
  | extend TargetResources = todynamic(TargetResources)
  | extend ServicePrincipalId = tostring(TargetResources[0].id)
  | extend ServicePrincipalName = tostring(TargetResources[0].displayName)
  | extend CredentialAdder = coalesce(tostring(InitiatedBy.user.userPrincipalName), tostring(InitiatedBy.app.displayName), "Unknown")
  | where isnotempty(ServicePrincipalId)
  | project CredentialTime=TimeGenerated, ServicePrincipalId, ServicePrincipalName, CredentialAdder, OperationName, Result;
  // Correlate creation and credential addition within a short window.
  CreationEvents
  | join kind=inner (CredentialEvents) on ServicePrincipalId
  | where CredentialTime between (CreationTime .. CreationTime + CorrelationWindow)
  | extend Account = CredentialAdder
  | project TimeGenerated=CredentialTime, Account, ServicePrincipalId, ServicePrincipalName, Creator, CredentialAdder, OperationName, Result, TimeSinceCreation=CredentialTime-CreationTime
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: Name
        columnName: Account
  - entityType: CloudApplication
    fieldMappings:
      - identifier: AppId
        columnName: ServicePrincipalId
      - identifier: Name
        columnName: ServicePrincipalName
kind: Scheduled
version: 1.0.0
