id: 0710c724-a738-4b0f-af52-947ba4f01c0d
name: Entra ID Password Spray
description: |
  Detects password spraying across multiple accounts from a single source IP using invalid credential outcomes.
  Data sources: SigninLogs (Microsoft Entra ID).
  Tuning: adjust MinDistinctAccounts/MinFailures and allowlist trusted egress IPs.
  Recommended actions: confirm source IP ownership, review targeted accounts, enforce MFA and account lockout policies.
severity: High
status: Production
requiredDataConnectors:
  - connectorId: AzureActiveDirectory
    dataTypes:
      - SigninLogs
queryFrequency: PT5M
queryPeriod: PT1H
triggerOperator: GreaterThan
triggerThreshold: 0
tactics:
  - CredentialAccess
  - InitialAccess
techniques:
  - T1110.003
query: |
  let QueryPeriod = 1h;
  let BinSize = 15m;
  let MinDistinctAccounts = 8;
  let MinFailures = 20;
  let AllowedIPs = dynamic([]); // Add trusted egress/VPN IPs here
  let AllowedClientApps = dynamic([]); // Optional: exclude known noisy client apps
  // Normalize failed sign-ins with invalid credential outcomes.
  let FailedSignins = SigninLogs
  | where TimeGenerated >= ago(QueryPeriod)
  | extend ResultTypeStr = tostring(ResultType)
  | where ResultTypeStr in ("50126", "50125", "50053", "50055", "50057")
  | extend Account = tostring(UserPrincipalName)
  | extend IPAddress = tostring(IPAddress)
  | extend AppDisplayName = tostring(AppDisplayName)
  | extend ClientAppUsed = tostring(ClientAppUsed)
  | extend UserAgent = tostring(UserAgent)
  | where IPAddress !in (AllowedIPs)
  | where isempty(AllowedClientApps) or ClientAppUsed !in (AllowedClientApps)
  | project TimeGenerated, Account, IPAddress, AppDisplayName, ClientAppUsed, UserAgent, ResultTypeStr;
  // Aggregate by IP to identify high-volume failures across multiple accounts.
  FailedSignins
  | summarize FailedCount=count(), DistinctAccounts=dcount(Account), Accounts=make_set(Account, 25), ResultTypes=make_set(ResultTypeStr, 10)
    by bin(TimeGenerated, BinSize), IPAddress, AppDisplayName, ClientAppUsed, UserAgent
  | where FailedCount >= MinFailures and DistinctAccounts >= MinDistinctAccounts
  | extend Account = "Multiple"
  | extend PrimaryAccount = tostring(Accounts[0])
  | project TimeGenerated, Account, PrimaryAccount, IPAddress, AppDisplayName, ClientAppUsed, UserAgent, FailedCount, DistinctAccounts, Accounts, ResultTypes
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: Name
        columnName: PrimaryAccount
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: IPAddress
kind: Scheduled
version: 1.0.0
