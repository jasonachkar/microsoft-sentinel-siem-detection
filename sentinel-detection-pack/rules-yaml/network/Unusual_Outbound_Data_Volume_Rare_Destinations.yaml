id: 5b584395-6a5c-46c8-8de7-1239c7188fe5
name: Unusual Outbound Data Volume to Rare Destination
description: |
  Detects high outbound data volume to destinations not seen in the baseline period.
  Data sources: CommonSecurityLog (CEF/Syslog).
  Tuning: adjust MinBytesOut and allowlist known data-transfer services.
  Recommended actions: validate destination ownership, review data transfer context, and inspect source host.
severity: High
status: Production
requiredDataConnectors:
  - connectorId: CommonSecurityLog
    dataTypes:
      - CommonSecurityLog
queryFrequency: PT5M
queryPeriod: PT1H
triggerOperator: GreaterThan
triggerThreshold: 0
tactics:
  - Exfiltration
techniques:
  - T1041
query: |
  let BaselinePeriod = 14d;
  let DetectionWindow = 1h;
  let MinBytesOut = 50000000; // 50 MB
  let AllowedDestinations = dynamic([]); // Optional allowlist for approved destinations
  let AllowedSources = dynamic([]); // Optional allowlist for data-mover hosts
  // Build baseline of known source-destination pairs.
  let Baseline = CommonSecurityLog
  | where TimeGenerated between (ago(BaselinePeriod) .. ago(DetectionWindow))
  | extend SourceIP = tostring(SourceIP)
  | extend DestinationIP = tostring(DestinationIP)
  | summarize by SourceIP, DestinationIP;
  // Aggregate recent outbound volume.
  let Recent = CommonSecurityLog
  | where TimeGenerated >= ago(DetectionWindow)
  | extend SourceIP = tostring(SourceIP)
  | extend DestinationIP = tostring(DestinationIP)
  | extend BytesOut = tolong(coalesce(column_ifexists("BytesSent", long(null)), column_ifexists("SentBytes", long(null)), column_ifexists("Bytes", long(null)), 0))
  | where SourceIP !in (AllowedSources)
  | where DestinationIP !in (AllowedDestinations)
  | summarize TotalBytesOut=sum(BytesOut), SessionCount=count(), FirstSeen=min(TimeGenerated), LastSeen=max(TimeGenerated),
             DestPorts=make_set(DestinationPort, 10), Vendors=make_set(DeviceVendor, 5), Products=make_set(DeviceProduct, 5)
    by SourceIP, DestinationIP, ApplicationProtocol;
  Recent
  | join kind=leftanti Baseline on SourceIP, DestinationIP
  | where TotalBytesOut >= MinBytesOut
  | project TimeGenerated=LastSeen, SourceIP, DestinationIP, ApplicationProtocol, TotalBytesOut, SessionCount, DestPorts, Vendors, Products, FirstSeen, LastSeen
entityMappings:
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: SourceIP
  - entityType: IP
    fieldMappings:
      - identifier: Address
        columnName: DestinationIP
kind: Scheduled
version: 1.0.0
