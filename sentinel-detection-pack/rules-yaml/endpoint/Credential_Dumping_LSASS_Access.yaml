id: 2cbf0368-8c26-4b6f-bc3f-15aa9e93ccfb
name: Credential Dumping via LSASS Access
description: |
  Detects process creation events associated with LSASS memory access or known dump tooling.
  Data sources: DeviceProcessEvents (Microsoft Defender for Endpoint).
  Tuning: allowlist approved dump tools or security products; refine SuspiciousCommandFragments.
  Recommended actions: isolate host, collect memory telemetry, and reset affected credentials.
severity: High
status: Production
requiredDataConnectors:
  - connectorId: MicrosoftThreatProtection
    dataTypes:
      - DeviceProcessEvents
queryFrequency: PT5M
queryPeriod: PT1H
triggerOperator: GreaterThan
triggerThreshold: 0
tactics:
  - CredentialAccess
techniques:
  - T1003.001
query: |
  let QueryPeriod = 1h;
  let SuspiciousProcessNames = dynamic(["procdump.exe", "rundll32.exe", "taskmgr.exe", "comsvcs.dll", "dumpert.exe", "pypykatz.exe", "mimikatz.exe"]);
  let SuspiciousCommandFragments = dynamic(["lsass", "comsvcs.dll", "MiniDump", "-ma", "-accepteula"]);
  let AllowedTools = dynamic([]); // Optional allowlist for approved memory dump utilities
  DeviceProcessEvents
  | where TimeGenerated >= ago(QueryPeriod)
  | where ActionType == "ProcessCreated"
  | extend ProcessName = tostring(FileName)
  | extend CommandLine = tostring(ProcessCommandLine)
  | extend Account = coalesce(tostring(InitiatingProcessAccountName), tostring(AccountName))
  | extend DeviceName = tostring(DeviceName)
  // Identify LSASS access patterns or known dump tooling.
  | where ProcessName in~ (SuspiciousProcessNames) or CommandLine has_any (SuspiciousCommandFragments)
  | where isempty(AllowedTools) or ProcessName !in~ (AllowedTools)
  | project TimeGenerated, Account, DeviceName, ProcessName, CommandLine, InitiatingProcessFileName, InitiatingProcessCommandLine
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: Name
        columnName: Account
  - entityType: Host
    fieldMappings:
      - identifier: HostName
        columnName: DeviceName
kind: Scheduled
version: 1.0.0
